<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‹¤æ€ ç®¡ç†</title>
  <style>
    :root {
      /* ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ç”¨ã®è‰²å¤‰æ•° */
      --bg-primary: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      --bg-container: rgba(255, 255, 255, 0.95);
      --bg-card: rgba(255, 255, 255, 0.8);
      --bg-result: rgba(249, 250, 251, 0.7);
      --bg-dropdown: rgba(255, 255, 255, 0.98);
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --text-tertiary: #64748b;
      --text-muted: #8e8e93;
      --border-primary: rgba(226, 232, 240, 0.8);
      --border-secondary: rgba(255, 255, 255, 0.5);
      --shadow-primary: 0 25px 50px rgba(0, 0, 0, 0.05), 0 10px 25px rgba(0, 0, 0, 0.03);
      --shadow-secondary: 0 8px 25px rgba(0, 0, 0, 0.03), 0 3px 10px rgba(0, 0, 0, 0.02);
    }

    [data-theme="dark"] {
      /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç”¨ã®è‰²å¤‰æ•° */
      --bg-primary: linear-gradient(135deg, #1e1e1e 0%, #2d2d30 100%);
      --bg-container: #2d2d30;
      --bg-card: #373738;
      --bg-result: #232326;
      --bg-dropdown: #2d2d30;
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
      --text-tertiary: #999999;
      --text-muted: #666666;
      --border-primary: #46464b;
      --border-secondary: #3c3c41;
      --shadow-primary: 0 25px 50px rgba(0, 0, 0, 0.5), 0 10px 25px rgba(0, 0, 0, 0.3);
      --shadow-secondary: 0 8px 25px rgba(0, 0, 0, 0.3), 0 3px 10px rgba(0, 0, 0, 0.2);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg-primary);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      color: var(--text-primary);
      line-height: 1.6;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .logo {
      margin-bottom: 30px;
      opacity: 0;
      animation: fadeInDown 0.6s ease-out 0.1s forwards;
    }

    .logo img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 
        0 20px 40px rgba(0,0,0,0.1),
        0 8px 16px rgba(0,0,0,0.06),
        0 0 0 1px rgba(255,255,255,0.9);
      border: 2px solid rgba(255, 255, 255, 0.8);
      transition: all 0.4s ease;
    }

    .logo img:hover {
      transform: scale(1.02) translateY(-2px);
      box-shadow: 
        0 25px 50px rgba(0,0,0,0.15),
        0 12px 20px rgba(0,0,0,0.08);
    }

    .container {
      background: var(--bg-container);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border-secondary);
      border-radius: 20px;
      padding: 32px;
      width: 100%;
      max-width: 800px;
      box-shadow: var(--shadow-primary);
      opacity: 0;
      animation: fadeInUp 0.8s ease-out 0.2s forwards;
      position: relative;
      transition: background 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
    }

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚³ãƒ³ãƒ†ãƒŠå¼·åˆ¶é©ç”¨ */
    [data-theme="dark"] .container {
      background: #2d2d30 !important;
      border: 1px solid #3c3c41 !important;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.8), transparent);
      border-radius: 24px 24px 0 0;
    }

    h1 {
      text-align: center;
      font-size: 1.75em;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 32px;
      letter-spacing: -0.025em;
      background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      transition: color 0.3s ease;
    }

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ */
    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--bg-container);
      border: 1px solid var(--border-primary);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.2em;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: var(--shadow-secondary);
      z-index: 1000;
    }

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ãƒ†ãƒ¼ãƒãƒˆã‚°ãƒ«å¼·åˆ¶é©ç”¨ */
    [data-theme="dark"] .theme-toggle {
      background: #2d2d30 !important;
      border: 1px solid #46464b !important;
    }

    .theme-toggle:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .form-group {
      margin-bottom: 18px;
      position: relative;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #424245;
      font-size: 0.85em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .input-wrapper {
      position: relative;
    }

    input[type="text"],
    input[type="time"],
    input[type="number"],
    input[type="date"] {
      width: 100%;
      padding: 12px 16px;
      font-size: 0.9em;
      border: 1px solid rgba(226, 232, 240, 0.8);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      outline: none;
      color: #1e293b;
      min-height: 42px;
      box-shadow: 
        0 2px 8px rgba(0, 0, 0, 0.02),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
      font-family: inherit;
    }

    input[type="text"]:focus,
    input[type="time"]:focus,
    input[type="number"]:focus,
    input[type="date"]:focus {
      border-color: #3b82f6;
      box-shadow: 
        0 0 0 3px rgba(59, 130, 246, 0.1),
        0 8px 24px rgba(0, 0, 0, 0.04),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
      background: rgba(255, 255, 255, 0.95);
      transform: translateY(-1px);
    }

    input[type="text"]::placeholder {
      color: var(--text-muted);
      transition: color 0.3s ease;
    }

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼æ”¹å–„ */
    [data-theme="dark"] input[type="text"]::placeholder {
      color: #888888;
    }

    /* number inputã®ã‚¹ãƒ”ãƒŠãƒ¼ã‚’è¡¨ç¤º */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: auto;
      margin: 0;
    }

    /* åå‰ã¨æ¤œç´¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å³ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ï¼ˆã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ç”¨ï¼‰ */
    #name, #searchName {
      padding-right: 40px;
    }

    /* ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .clear-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 24px;
      height: 24px;
      border: none;
      background: var(--border-primary);
      color: var(--text-muted);
      border-radius: 50%;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      z-index: 10;
      line-height: 1;
    }

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³å¼·åˆ¶é©ç”¨ */
    [data-theme="dark"] .clear-btn {
      background: #46464b !important;
      color: #cccccc !important;
    }

    .clear-btn:hover {
      background: var(--border-primary);
      color: var(--text-secondary);
      transform: translateY(-50%) scale(1.05);
    }

    [data-theme="dark"] .clear-btn:hover {
      background: #505055 !important;
      color: #ffffff !important;
    }

    .clear-btn:active {
      background: var(--border-primary);
      transform: translateY(-50%) scale(0.95);
    }

    .clear-btn.show {
      display: flex;
      animation: fadeInScale 0.2s ease-out;
    }

    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: translateY(-50%) scale(0.8);
      }
      to {
        opacity: 1;
        transform: translateY(-50%) scale(1);
      }
    }

    /* ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--bg-dropdown);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border-secondary);
      border-radius: 16px;
      box-shadow: var(--shadow-primary);
      z-index: 1000;
      max-height: 280px;
      overflow-x: hidden;
      overflow-y: auto;
      display: none;
      margin-top: 4px;
      animation: slideDown 0.3s ease-out;
      scrollbar-width: thin;
      scrollbar-color: var(--text-muted) transparent;
      transition: background 0.3s ease, border-color 0.3s ease;
    }

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¼·åˆ¶é©ç”¨ */
    [data-theme="dark"] .dropdown-menu {
      background: #2d2d30 !important;
      border: 1px solid #3c3c41 !important;
    }

    .dropdown-menu::-webkit-scrollbar {
      width: 6px;
    }

    .dropdown-menu::-webkit-scrollbar-track {
      background: transparent;
    }

    .dropdown-menu::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 3px;
    }

    .dropdown-menu::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.3);
    }

    .dropdown-menu.show {
      display: block;
    }

    .dropdown-item {
      padding: 16px 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #1e293b;
      font-size: 1em;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      justify-content: space-between;
      min-height: 56px;
    }

    .dropdown-item:last-child {
      border-bottom: none;
    }

    .dropdown-item:hover {
      background: rgba(59, 130, 246, 0.08);
      color: #3b82f6;
      transform: translateX(4px);
    }

    .dropdown-item:first-child {
      border-radius: 16px 16px 0 0;
    }

    .dropdown-item:last-child {
      border-radius: 0 0 16px 16px;
    }

    .dropdown-item:first-child:last-child {
      border-radius: 16px;
    }

    .dropdown-item-info {
      font-size: 0.8em;
      color: #8e8e93;
      margin-left: 8px;
    }

    .dropdown-empty {
      padding: 24px 20px;
      text-align: center;
      color: #8e8e93;
      font-style: italic;
      font-size: 0.95em;
    }

    /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-right: 8px;
      accent-color: #3b82f6;
      cursor: pointer;
    }

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹æ”¹å–„ */
    [data-theme="dark"] input[type="checkbox"] {
      background: rgba(60, 60, 65, 0.8);
      border: 1px solid rgba(80, 80, 85, 0.6);
      accent-color: #3b82f6;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      font-size: 0.95em;
      color: var(--text-secondary);
      cursor: pointer;
      text-transform: none;
      letter-spacing: normal;
      margin-bottom: 0;
      transition: color 0.3s ease;
    }

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ãƒ©ãƒ™ãƒ«è‰²æ”¹å–„ */
    [data-theme="dark"] .checkbox-label {
      color: #cccccc;
    }

    /* ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
    button {
      font-family: inherit;
      font-size: 0.85em;
      font-weight: 500;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      outline: none;
      min-height: 38px;
      backdrop-filter: blur(10px);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      margin: 0; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒãƒ¼ã‚¸ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ */
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    /* ãƒ—ãƒ©ã‚¤ãƒãƒªãƒœã‚¿ãƒ³ */
    .btn-primary {
      padding: 10px 18px;
      color: #ffffff;
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      box-shadow: 
        0 4px 12px rgba(59, 130, 246, 0.25),
        0 2px 6px rgba(59, 130, 246, 0.15);
    }

    .btn-primary:hover:not(:disabled) {
      background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
      transform: translateY(-1px);
      box-shadow: 
        0 6px 16px rgba(59, 130, 246, 0.3),
        0 3px 8px rgba(59, 130, 246, 0.2);
    }

    /* ã‚»ã‚«ãƒ³ãƒ€ãƒªãƒœã‚¿ãƒ³ */
    .btn-secondary {
      padding: 10px 18px;
      color: #3b82f6;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #3b82f6;
    }

    .btn-secondary:hover:not(:disabled) {
      background: rgba(59, 130, 246, 0.05);
      transform: translateY(-1px);
    }

    /* æˆåŠŸãƒœã‚¿ãƒ³ */
    .btn-success {
      padding: 10px 18px;
      color: #ffffff;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      box-shadow: 
        0 4px 12px rgba(16, 185, 129, 0.25),
        0 2px 6px rgba(16, 185, 129, 0.15);
    }

    .btn-success:hover:not(:disabled) {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      transform: translateY(-1px);
    }

    /* å±é™ºãƒœã‚¿ãƒ³ */
    .btn-danger {
      padding: 10px 18px;
      color: #ffffff;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      box-shadow: 
        0 4px 12px rgba(239, 68, 68, 0.25),
        0 2px 6px rgba(239, 68, 68, 0.15);
    }

    .btn-danger:hover:not(:disabled) {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      transform: translateY(-1px);
    }

    /* è­¦å‘Šãƒœã‚¿ãƒ³ */
    .btn-warning {
      padding: 10px 18px;
      color: #ffffff;
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      box-shadow: 
        0 4px 12px rgba(245, 158, 11, 0.25),
        0 2px 6px rgba(245, 158, 11, 0.15);
    }

    .btn-warning:hover:not(:disabled) {
      background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
      transform: translateY(-1px);
    }

    /* æ·±ç·‘ãƒœã‚¿ãƒ³ï¼ˆExcelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨ï¼‰ */
    .btn-dark-success {
      padding: 10px 18px;
      color: #ffffff;
      background: linear-gradient(135deg, #047857 0%, #065f46 100%);
      box-shadow: 
        0 4px 12px rgba(4, 120, 87, 0.3),
        0 2px 6px rgba(4, 120, 87, 0.2);
    }

    .btn-dark-success:hover:not(:disabled) {
      background: linear-gradient(135deg, #065f46 0%, #064e3b 100%);
      transform: translateY(-1px);
      box-shadow: 
        0 6px 16px rgba(4, 120, 87, 0.4),
        0 3px 8px rgba(4, 120, 87, 0.25);
    }
    .btn-info {
      padding: 10px 18px;
      color: #ffffff;
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      box-shadow: 
        0 4px 12px rgba(6, 182, 212, 0.25),
        0 2px 6px rgba(6, 182, 212, 0.15);
    }

    .btn-info:hover:not(:disabled) {
      background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
      transform: translateY(-1px);
    }

    /* å°ã•ãªãƒœã‚¿ãƒ³ */
    .btn-sm {
      padding: 6px 12px;
      font-size: 0.75em;
      border-radius: 8px;
      min-height: 30px;
    }

    /* æ¥µå°ãƒœã‚¿ãƒ³ */
    .btn-xs {
      padding: 6px 12px;
      font-size: 0.75em;
      border-radius: 8px;
      min-height: 32px;
    }

    /* ãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ— */
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin: 12px 0;
    }

    .btn-group.main-buttons {
      margin: 16px 0;
    }

    /* ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒªã‚¹ãƒˆã‚¢ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
    .backup-restore-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin: 12px 0;
    }

    /* çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ */
    #result {
      margin-top: 32px;
      background: rgba(249, 250, 251, 0.7);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 28px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 
        0 8px 25px rgba(0, 0, 0, 0.03),
        0 3px 10px rgba(0, 0, 0, 0.02),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    }

    #result h2 {
      font-size: 1.3em;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 24px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e2e8f0;
      background: linear-gradient(135deg, #1e293b 0%, #3b82f6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    #result h3 {
      color: var(--text-primary);
      font-size: 1.1em;
      font-weight: 600;
      margin: 24px 0 16px 0;
      padding: 12px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      transition: color 0.3s ease, background 0.3s ease, border-color 0.3s ease;
    }

    #result h4 {
      color: #64748b;
      font-size: 0.95em;
      font-weight: 500;
      margin: 16px 0 12px 20px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 8px;
      border-left: 3px solid #cbd5e1;
    }

    #result hr {
      margin: 16px 0;
      border: none;
      border-top: 1px solid rgba(226, 232, 240, 0.6);
    }

    /* ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .record-card {
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(226, 232, 240, 0.5);
      border-radius: 12px;
      padding: 14px 16px;
      margin: 8px 0;
      transition: all 0.2s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 60px;
    }

    .record-card:hover {
      background: rgba(255, 255, 255, 0.95);
      border-color: rgba(59, 130, 246, 0.2);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .record-info {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      flex: 1;
    }

    .record-buttons {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-shrink: 0;
      margin-left: 16px;
    }

    .record-time {
      font-weight: 600;
      color: #1e293b;
      font-size: 0.9em;
    }

    .record-date {
      font-weight: 600;
      color: #1e293b;
      font-size: 0.85em;
      margin-right: 8px;
      padding: 4px 8px;
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: 6px;
      transition: all 0.3s ease;
    }

    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ«æ”¹å–„ */
    .record-status {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 0.75em;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
      border: none;
      position: relative;
      margin-left: 8px;
    }

    .status-paid {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: #ffffff;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      box-shadow: 
        0 3px 8px rgba(139, 92, 246, 0.4),
        0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .status-complete {
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      color: #ffffff;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      box-shadow: 
        0 3px 8px rgba(34, 197, 94, 0.3),
        0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .status-incomplete {
      background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
      color: #ffffff;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      box-shadow: 
        0 3px 8px rgba(248, 113, 113, 0.3),
        0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* iOSé¢¨é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ  */
    .toast-notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-container);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      padding: 16px 24px;
      box-shadow: var(--shadow-primary);
      z-index: 2000;
      opacity: 0;
      transform: translateX(-50%) translateY(-100%) scale(0.9);
      animation: slideInToast 0.4s ease-out forwards;
      max-width: 400px;
      min-width: 300px;
      transition: background 0.3s ease, border-color 0.3s ease;
    }

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®é€šçŸ¥å¼·åˆ¶é©ç”¨ */
    [data-theme="dark"] .toast-notification {
      background: #2d2d30 !important;
      border: 1px solid #46464b !important;
    }

    .toast-notification.success {
      border-left: 4px solid #22c55e;
    }

    .toast-notification.error {
      border-left: 4px solid #ef4444;
    }

    .toast-notification.info {
      border-left: 4px solid #3b82f6;
    }

    .toast-notification.warning {
      border-left: 4px solid #f59e0b;
    }

    .toast-content {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .toast-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      color: white;
      flex-shrink: 0;
    }

    .toast-notification.success .toast-icon {
      background: #22c55e;
    }

    .toast-notification.error .toast-icon {
      background: #ef4444;
    }

    .toast-notification.info .toast-icon {
      background: #3b82f6;
    }

    .toast-notification.warning .toast-icon {
      background: #f59e0b;
    }

    .toast-message {
      flex: 1;
      font-size: 0.95em;
      font-weight: 500;
      color: var(--text-primary);
      line-height: 1.4;
      transition: color 0.3s ease;
    }

    @keyframes slideInToast {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-100%) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0) scale(1);
      }
    }

    @keyframes slideOutToast {
      from {
        opacity: 1;
        transform: translateX(-50%) translateY(0) scale(1);
      }
      to {
        opacity: 0;
        transform: translateX(-50%) translateY(-100%) scale(0.9);
      }
    }

    /* iOSé¢¨ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
    .ios-dialog {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      opacity: 0;
      animation: fadeIn 0.3s ease-out forwards;
    }

    .ios-dialog-content {
      background: var(--bg-container);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 20px;
      width: 320px;
      max-width: 90vw;
      overflow: hidden;
      box-shadow: var(--shadow-primary);
      transform: scale(0.9);
      animation: dialogScale 0.3s ease-out forwards;
      transition: background 0.3s ease;
    }

    /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ãƒ€ã‚¤ã‚¢ãƒ­ã‚°å¼·åˆ¶é©ç”¨ */
    [data-theme="dark"] .ios-dialog-content {
      background: #2d2d30 !important;
    }

    .ios-dialog-header {
      padding: 24px 20px 16px;
      text-align: center;
      border-bottom: 1px solid var(--border-primary);
      transition: border-color 0.3s ease;
    }

    [data-theme="dark"] .ios-dialog-header {
      border-bottom: 1px solid #46464b !important;
    }

    .ios-dialog-title {
      font-size: 1.1em;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
      transition: color 0.3s ease;
    }

    .ios-dialog-message {
      font-size: 0.9em;
      color: var(--text-secondary);
      line-height: 1.4;
      white-space: pre-line;
      transition: color 0.3s ease;
    }

    .ios-dialog-buttons {
      display: flex;
      background: var(--bg-card);
      transition: background 0.3s ease;
    }

    [data-theme="dark"] .ios-dialog-buttons {
      background: #373738 !important;
    }

    .ios-dialog-button {
      flex: 1;
      padding: 16px;
      border: none;
      background: transparent;
      font-size: 1em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #3b82f6;
    }

    .ios-dialog-button:hover {
      background: rgba(59, 130, 246, 0.1);
    }

    .ios-dialog-button.primary {
      color: #ef4444;
      font-weight: 600;
    }

    .ios-dialog-button.primary:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    .ios-dialog-button + .ios-dialog-button {
      border-left: 1px solid var(--border-primary);
      transition: border-color 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes dialogScale {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹ */
    .hidden {
      display: none !important;
    }

    .text-center {
      text-align: center;
    }

    .mb-0 { margin-bottom: 0; }
    .mb-1 { margin-bottom: 8px; }
    .mb-2 { margin-bottom: 16px; }
    .mb-3 { margin-bottom: 24px; }

    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
    @media (max-width: 768px) {
      .container {
        padding: 20px 16px;
        margin: 10px;
        border-radius: 16px;
      }

      h1 {
        font-size: 1.5em;
        margin-bottom: 24px;
      }

      .form-group {
        margin-bottom: 14px;
      }

      input[type="text"],
      input[type="time"],
      input[type="number"],
      input[type="date"] {
        padding: 10px 14px;
        min-height: 38px;
      }

      .btn-group,
      .backup-restore-buttons {
        flex-direction: column;
        align-items: stretch;
      }

      .btn-group button,
      .backup-restore-buttons button {
        width: 100%;
        margin-bottom: 6px;
      }

      .btn-group button:last-child,
      .backup-restore-buttons button:last-child {
        margin-bottom: 0;
      }

      .dropdown-menu {
        max-height: 200px;
        border-radius: 10px;
      }

      .dropdown-item {
        padding: 12px 14px;
        min-height: 44px;
      }

      #result {
        padding: 16px;
      }

      .record-card {
        padding: 10px 12px;
        flex-direction: column;
        align-items: stretch;
        min-height: auto;
      }

      .record-info {
        margin-bottom: 8px;
        justify-content: flex-start;
      }

      .record-buttons {
        justify-content: flex-start;
        margin-top: 8px;
        margin-left: 0;
        width: 100%;
      }

      .record-buttons button {
        flex: 1;
        min-width: 70px;
      }

      #result > div {
        margin-left: 12px;
      }

      /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®é€šçŸ¥ä½ç½®èª¿æ•´ */
      .toast-notification {
        left: 10px;
        right: 10px;
        transform: translateX(0);
        max-width: none;
      }

      @keyframes slideInToast {
        from {
          opacity: 0;
          transform: translateY(-100%) scale(0.9);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      @keyframes slideOutToast {
        from {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
        to {
          opacity: 0;
          transform: translateY(-100%) scale(0.9);
        }
      }
    }

    @media (min-width: 769px) and (max-width: 1024px) {
      .container {
        max-width: 900px;
        padding: 28px;
      }

      .dropdown-menu {
        max-height: 280px;
      }
    }

    @media (min-width: 1025px) {
      .container {
        max-width: 1000px;
      }
    }

    /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
    button:focus-visible {
      outline: 2px solid #3b82f6;
      outline-offset: 2px;
    }

    input:focus-visible {
      outline: none;
    }

    /* å°åˆ·ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    @media print {
      body {
        background: white;
      }
      
      .container {
        background: white;
        box-shadow: none;
        border: 1px solid #ccc;
      }
      
      button {
        display: none;
      }
      
      .backup-restore-buttons {
        display: none;
      }
    }
  </style>
</head>
<body>
  <!-- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ãƒˆã‚°ãƒ« -->
  <button class="theme-toggle" id="themeToggle">ğŸŒ™</button>

  <div class="logo">
    <img src="logo.png" alt="å‹¤æ€ ç®¡ç†ãƒ­ã‚´">
  </div>

  <div class="container">
    <h1>å‹¤æ€ ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>

    <!-- ãƒ•ã‚©ãƒ¼ãƒ é–‹å§‹ -->
    <form id="timeCardForm">

      <div class="form-group">
        <label for="name">åå‰</label>
        <div class="input-wrapper">
          <input type="text" id="name" required placeholder="å¾“æ¥­å“¡åã‚’å…¥åŠ›">
          <button type="button" class="clear-btn" id="clearNameBtn">Ã—</button>
          <div class="dropdown-menu" id="nameDropdown"></div>
        </div>
      </div>

      <div class="form-group" id="normalDateGroup">
        <label for="dateSingle">æœˆæ—¥</label>
        <input type="date" id="dateSingle" required>
      </div>

      <div class="form-group hidden" id="paidLeaveYearGroup">
        <label for="paidLeaveYear">æœ‰çµ¦ç”¨ è¥¿æš¦</label>
        <input type="number" id="paidLeaveYear" min="2020" max="2030" step="1">
      </div>

      <div class="form-group hidden" id="multiDateGroup">
        <label for="dateMulti">æœˆæ—¥ (è¤‡æ•°å…¥åŠ›ã€ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label>
        <input type="text" id="dateMulti" placeholder="ä¾‹: 03-10, 03-11">
      </div>

      <div class="form-group">
        <label for="checkIn">å‡ºå‹¤æ™‚é–“</label>
        <input type="time" id="checkIn" required>
      </div>
      
      <div class="form-group">
        <label for="checkOut">é€€å‹¤æ™‚é–“</label>
        <input type="time" id="checkOut">
      </div>

      <!-- æœ‰çµ¦ãƒã‚§ãƒƒã‚¯ -->
      <div class="form-group">
        <label class="checkbox-label">
          <input type="checkbox" id="isPaidLeave">
          æœ‰çµ¦ã¨ã—ã¦ç™»éŒ²ã™ã‚‹
        </label>
      </div>

      <!-- ãƒ•ã‚©ãƒ¼ãƒ å†…ã®ãƒœã‚¿ãƒ³ -->
      <div class="btn-group main-buttons">
        <button type="submit" id="submitBtn" class="btn-primary">é€ä¿¡</button>
        <button type="button" id="cancelEditBtn" class="btn-secondary hidden">ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="button" id="exportBtn" class="btn-dark-success">Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <button type="button" id="clearDataBtn" class="btn-danger">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢</button>
      </div>

    </form>
    <!-- ãƒ•ã‚©ãƒ¼ãƒ çµ‚äº† -->

    <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒªã‚¹ãƒˆã‚¢ã®ãƒœã‚¿ãƒ³ -->
    <div class="backup-restore-buttons">
      <button type="button" id="backupBtn" class="btn-success">ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
      <button type="button" id="backupLatestMonthBtn" class="btn-info">æœ€æ–°ã®æœˆã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
      <input type="file" id="restoreFile" style="display: none;">
      <button type="button" id="restoreBtn" class="btn-warning">ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚¹ãƒˆã‚¢</button>
    </div>

    <!-- æ¤œç´¢ -->
    <div class="form-group">
      <label for="searchName">åå‰ã§æ¤œç´¢</label>
      <div class="input-wrapper">
        <input type="text" id="searchName" placeholder="åå‰ã‚’å…¥åŠ›ã—ã¦æ¤œç´¢">
        <button type="button" class="clear-btn" id="clearSearchBtn">Ã—</button>
        <div class="dropdown-menu" id="searchDropdown"></div>
      </div>
    </div>

    <!-- ã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰ä¸€è¦§è¡¨ç¤º -->
    <div id="result"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <script>
/***********************************************
 * ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ©Ÿèƒ½
 ***********************************************/

// ãƒ†ãƒ¼ãƒã®åˆæœŸåŒ–ã¨åˆ‡ã‚Šæ›¿ãˆ
function initTheme() {
  const savedTheme = localStorage.getItem('theme') || 'light';
  applyTheme(savedTheme);
}

function applyTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme);
  const themeToggle = document.getElementById('themeToggle');
  if (themeToggle) {
    themeToggle.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
  }
  localStorage.setItem('theme', theme);
  
  // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ™‚ã®å¼·åˆ¶ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
  if (theme === 'dark') {
    applyDarkModeStyles();
  } else {
    removeDarkModeStyles();
  }
}

function applyDarkModeStyles() {
  // æ—¢å­˜ã®ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ãŒã‚ã‚Œã°å‰Šé™¤
  const existingStyle = document.getElementById('dark-mode-override');
  if (existingStyle) {
    existingStyle.remove();
  }
  
  // æ–°ã—ã„ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ 
  const style = document.createElement('style');
  style.id = 'dark-mode-override';
  style.textContent = `
    [data-theme="dark"] body {
      background: linear-gradient(135deg, #1e1e1e 0%, #2d2d30 100%) !important;
      color: #ffffff !important;
    }
    
    [data-theme="dark"] .container {
      background: #2d2d30 !important;
      border: 1px solid #46464b !important;
      color: #ffffff !important;
    }
    
    [data-theme="dark"] h1 {
      color: #ffffff !important;
    }
    
    [data-theme="dark"] label {
      color: #cccccc !important;
    }
    
    [data-theme="dark"] input[type="text"],
    [data-theme="dark"] input[type="time"], 
    [data-theme="dark"] input[type="number"],
    [data-theme="dark"] input[type="date"] {
      background: #3c3c41 !important;
      border: 1px solid #505055 !important;
      color: #ffffff !important;
    }
    
    [data-theme="dark"] input[type="text"]:focus,
    [data-theme="dark"] input[type="time"]:focus,
    [data-theme="dark"] input[type="number"]:focus,
    [data-theme="dark"] input[type="date"]:focus {
      background: #46464b !important;
      border-color: #3b82f6 !important;
      color: #ffffff !important;
    }
    
    [data-theme="dark"] input[type="text"]::placeholder {
      color: #888888 !important;
    }
    
    [data-theme="dark"] #result {
      background: #232326 !important;
      border: 1px solid #46464b !important;
      color: #ffffff !important;
    }
    
    [data-theme="dark"] #result h2 {
      color: #ffffff !important;
      border-bottom: 2px solid #46464b !important;
      background: none !important;
      -webkit-background-clip: initial !important;
      -webkit-text-fill-color: #ffffff !important;
      background-clip: initial !important;
    }
    
    [data-theme="dark"] #result h3 {
      color: #ffffff !important;
      background: #373738 !important;
      border: 1px solid #46464b !important;
    }
    
    [data-theme="dark"] .record-card {
      background: #373738 !important;
      border: 1px solid #46464b !important;
      color: #ffffff !important;
    }
    
    [data-theme="dark"] .record-card:hover {
      background: #404045 !important;
      border-color: rgba(59, 130, 246, 0.5) !important;
    }
    
    [data-theme="dark"] .record-time,
    [data-theme="dark"] .record-date {
      color: #ffffff !important;
    }
    
    [data-theme="dark"] .record-date {
      background: rgba(59, 130, 246, 0.2) !important;
      border: 1px solid rgba(59, 130, 246, 0.4) !important;
    }
    
    [data-theme="dark"] .record-date {
      background: rgba(59, 130, 246, 0.2) !important;
      border: 1px solid rgba(59, 130, 246, 0.4) !important;
    }
    
    [data-theme="dark"] .dropdown-menu {
      background: #2d2d30 !important;
      border: 1px solid #46464b !important;
    }
    
    [data-theme="dark"] .dropdown-item {
      color: #ffffff !important;
      border-bottom: 1px solid #46464b !important;
    }
    
    [data-theme="dark"] .dropdown-item-info {
      color: #888888 !important;
    }
    
    [data-theme="dark"] .dropdown-empty {
      color: #888888 !important;
    }
    
    [data-theme="dark"] .checkbox-label {
      color: #cccccc !important;
    }
    
    [data-theme="dark"] .clear-btn {
      background: #46464b !important;
      color: #cccccc !important;
    }
    
    [data-theme="dark"] .clear-btn:hover {
      background: #505055 !important;
      color: #ffffff !important;
    }
    
    [data-theme="dark"] .theme-toggle {
      background: #2d2d30 !important;
      border: 1px solid #46464b !important;
    }
    
    [data-theme="dark"] .toast-notification {
      background: #2d2d30 !important;
      border: 1px solid #46464b !important;
    }
    
    [data-theme="dark"] .toast-message {
      color: #ffffff !important;
    }
    
    [data-theme="dark"] .ios-dialog-content {
      background: #2d2d30 !important;
    }
    
    [data-theme="dark"] .ios-dialog-header {
      border-bottom: 1px solid #46464b !important;
    }
    
    [data-theme="dark"] .ios-dialog-title {
      color: #ffffff !important;
    }
    
    [data-theme="dark"] .ios-dialog-message {
      color: #cccccc !important;
    }
    
    [data-theme="dark"] .ios-dialog-buttons {
      background: #373738 !important;
    }
    
    [data-theme="dark"] .ios-dialog-button {
      color: #3b82f6 !important;
    }
    
    [data-theme="dark"] .ios-dialog-button.primary {
      color: #ef4444 !important;
    }
    
    [data-theme="dark"] .ios-dialog-button + .ios-dialog-button {
      border-left: 1px solid #46464b !important;
    }
    
    [data-theme="dark"] .btn-secondary {
      background: #373738 !important;
      border: 1px solid #46464b !important;
      color: #3b82f6 !important;
    }
    
    [data-theme="dark"] .btn-secondary:hover:not(:disabled) {
      background: rgba(59, 130, 246, 0.1) !important;
    }
  `;
  document.head.appendChild(style);
}

function removeDarkModeStyles() {
  const existingStyle = document.getElementById('dark-mode-override');
  if (existingStyle) {
    existingStyle.remove();
  }
}

function toggleTheme() {
  const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  applyTheme(newTheme);
  showToast(`${newTheme === 'dark' ? 'ãƒ€ãƒ¼ã‚¯' : 'ãƒ©ã‚¤ãƒˆ'}ãƒ¢ãƒ¼ãƒ‰ã«å¤‰æ›´ã—ã¾ã—ãŸ`, 'info', 2000);
}

/***********************************************
 * ç·¨é›†æ©Ÿèƒ½ç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
 ***********************************************/
let editingRecord = null; // ç·¨é›†ä¸­ã®ãƒ¬ã‚³ãƒ¼ãƒ‰æƒ…å ± {name, date, index}

/***********************************************
 * ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³æ©Ÿèƒ½ã®å¤‰æ•°ã¨ãƒ•ãƒ©ã‚°
 ***********************************************/
let isDropdownActionInProgress = false;

/***********************************************
 * iOSé¢¨é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
 ***********************************************/

// iOSé¢¨é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
function showToast(message, type = 'info', duration = 3000) {
  const toast = document.createElement('div');
  toast.className = `toast-notification ${type}`;
  
  const iconMap = {
    success: 'âœ“',
    error: 'âœ•',
    info: 'i',
    warning: '!'
  };
  
  toast.innerHTML = `
    <div class="toast-content">
      <div class="toast-icon">${iconMap[type] || 'i'}</div>
      <div class="toast-message">${message}</div>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  // è‡ªå‹•å‰Šé™¤
  setTimeout(() => {
    toast.style.animation = 'slideOutToast 0.3s ease-in forwards';
    setTimeout(() => {
      if (document.body.contains(toast)) {
        document.body.removeChild(toast);
      }
    }, 300);
  }, duration);
}

// iOSé¢¨ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
function showConfirmDialog(title, message, onConfirm, confirmText = 'å‰Šé™¤', cancelText = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«') {
  return new Promise((resolve) => {
    const dialog = document.createElement('div');
    dialog.className = 'ios-dialog';
    
    dialog.innerHTML = `
      <div class="ios-dialog-content">
        <div class="ios-dialog-header">
          <div class="ios-dialog-title">${title}</div>
          <div class="ios-dialog-message">${message}</div>
        </div>
        <div class="ios-dialog-buttons">
          <button class="ios-dialog-button">${cancelText}</button>
          <button class="ios-dialog-button primary">${confirmText}</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(dialog);
    
    const [cancelBtn, confirmBtn] = dialog.querySelectorAll('.ios-dialog-button');
    
    const closeDialog = () => {
      dialog.style.opacity = '0';
      setTimeout(() => {
        if (document.body.contains(dialog)) {
          document.body.removeChild(dialog);
        }
      }, 300);
    };
    
    cancelBtn.addEventListener('click', () => {
      closeDialog();
      resolve(false);
    });
    
    confirmBtn.addEventListener('click', () => {
      onConfirm();
      closeDialog();
      resolve(true);
    });
    
    // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    dialog.addEventListener('click', (e) => {
      if (e.target === dialog) {
        closeDialog();
        resolve(false);
      }
    });
  });
}

// iOSé¢¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°
function showPromptDialog(title, message, defaultValue = '') {
  return new Promise((resolve) => {
    const dialog = document.createElement('div');
    dialog.className = 'ios-dialog';
    
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const inputStyle = isDark ? `
      width: 100%;
      margin-top: 16px;
      padding: 12px;
      border: 1px solid rgba(80, 80, 85, 0.6);
      border-radius: 8px;
      font-size: 1em;
      outline: none;
      background: rgba(60, 60, 65, 0.8);
      color: #ffffff;
    ` : `
      width: 100%;
      margin-top: 16px;
      padding: 12px;
      border: 1px solid rgba(0,0,0,0.2);
      border-radius: 8px;
      font-size: 1em;
      outline: none;
    `;
    
    dialog.innerHTML = `
      <div class="ios-dialog-content">
        <div class="ios-dialog-header">
          <div class="ios-dialog-title">${title}</div>
          <div class="ios-dialog-message">${message}</div>
          <input type="text" value="${defaultValue}" style="${inputStyle}">
        </div>
        <div class="ios-dialog-buttons">
          <button class="ios-dialog-button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="ios-dialog-button primary">OK</button>
        </div>
      </div>
    `;
    
    document.body.appendChild(dialog);
    
    const input = dialog.querySelector('input');
    const [cancelBtn, confirmBtn] = dialog.querySelectorAll('.ios-dialog-button');
    
    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
    setTimeout(() => input.focus(), 100);
    
    const closeDialog = () => {
      dialog.style.opacity = '0';
      setTimeout(() => {
        if (document.body.contains(dialog)) {
          document.body.removeChild(dialog);
        }
      }, 300);
    };
    
    cancelBtn.addEventListener('click', () => {
      closeDialog();
      resolve(null);
    });
    
    confirmBtn.addEventListener('click', () => {
      const value = input.value.trim();
      closeDialog();
      resolve(value);
    });
    
    // Enterã‚­ãƒ¼ã§ç¢ºå®š
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const value = input.value.trim();
        closeDialog();
        resolve(value);
      }
    });
  });
}

/***********************************************
 * æœŸé–“å–å¾—ç”¨ é–¢æ•°ç¾¤
 *   æ¯æœˆ11æ—¥ï½ç¿Œæœˆ10æ—¥ã‚’1æœŸé–“ã¨ã™ã‚‹
 ***********************************************/

/**
 * ä¸ãˆã‚‰ã‚ŒãŸ "YYYY-MM-DD" ãŒå«ã¾ã‚Œã‚‹æœŸé–“ã®é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’è¿”ã™ã€‚
 *   ä¾‹: 2/11ï½3/10 ã¯ start=2/11, end=3/10
 *   ä¾‹: 3/11ï½4/10 ã¯ start=3/11, end=4/10
 */
function getMonthPeriod(dateString) {
  const date = new Date(dateString);
  const day = date.getDate();
  let startYear = date.getFullYear();
  let startMonth = date.getMonth(); // 0-11
  if (day < 11) {
    // 11æ—¥ã‚ˆã‚Šå‰ãªã‚‰å…ˆæœˆ11æ—¥ï½å½“æœˆ10æ—¥ãŒæœŸé–“
    startMonth--;
    if (startMonth < 0) {
      startMonth = 11;
      startYear--;
    }
  }
  const start = new Date(startYear, startMonth, 11);

  // çµ‚äº†æ—¥ã¯ startã®æœˆ+1 ã®10æ—¥
  let endYear = startYear;
  let endMonth = startMonth + 1;
  if (endMonth > 11) {
    endMonth = 0;
    endYear++;
  }
  const end = new Date(endYear, endMonth, 10);
  return { start, end };
}

/**
 * ä»Šæ—¥åŸºæº–ã§ã€Œæœ€æ–°ã®æœˆã€(æ¯æœˆ11æ—¥é–‹å§‹ï½ç¿Œæœˆ10æ—¥çµ‚äº†) ã‚’è¿”ã™ã€‚
 */
function getLatestMonthPeriod() {
  const today = new Date();
  const day = today.getDate();
  let startYear = today.getFullYear();
  let startMonth = today.getMonth();
  if (day < 11) {
    startMonth--;
    if (startMonth < 0) {
      startMonth = 11;
      startYear--;
    }
  }
  const start = new Date(startYear, startMonth, 11);

  let endYear = startYear;
  let endMonth = startMonth + 1;
  if (endMonth > 11) {
    endMonth = 0;
    endYear++;
  }
  const end = new Date(endYear, endMonth, 10);
  return { start, end };
}

/***********************************************
 * è¨ˆç®—ãƒ»ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
 ***********************************************/

// å‡ºå‹¤ãƒ»é€€å‹¤ã®å·®(å°æ•°ç‚¹2æ¡)
function calculateTimeDifference(startTime, endTime) {
  const start = new Date(`1970-01-01T${startTime}`);
  const end = new Date(`1970-01-01T${endTime}`);
  const diff = (end - start) / (1000 * 60 * 60);
  return parseFloat(diff.toFixed(2));
}

// æ—©æœå‹¤å‹™æ™‚é–“(08:30ã¾ã§)
function calculateEarlyMorningTime(startTime, endTime) {
  const endLimit = new Date('1970-01-01T08:30');
  const start = new Date(`1970-01-01T${startTime}`);
  const end = new Date(`1970-01-01T${endTime}`);
  if (end <= endLimit) {
    return calculateTimeDifference(startTime, endTime);
  } else if (start < endLimit) {
    return calculateTimeDifference(startTime, '08:30');
  }
  return 0;
}

// å¤•æ–¹å‹¤å‹™æ™‚é–“(16:00ä»¥é™)
function calculateEveningTime(startTime, endTime) {
  const startLimit = new Date('1970-01-01T16:00');
  const start = new Date(`1970-01-01T${startTime}`);
  const end = new Date(`1970-01-01T${endTime}`);
  if (start >= startLimit) {
    return calculateTimeDifference(startTime, endTime);
  } else if (end > startLimit) {
    return calculateTimeDifference('16:00', endTime);
  }
  return 0;
}

// "YYYY-MM-DD" â†’ "MM-DD"
function formatDate(dateString) {
  const parts = dateString.split('-');
  if (parts.length === 3) {
    return `${parts[1]}-${parts[2]}`;
  }
  return dateString;
}

/***********************************************
 * ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³æ©Ÿèƒ½
 ***********************************************/

// åå‰ã®ä½¿ç”¨é †åºã‚’æ›´æ–°
function updateNameUsageOrder(name) {
  let nameUsage = JSON.parse(localStorage.getItem('nameUsageOrder') || '{}');
  // ç¾åœ¨ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä½¿ç”¨é †åºã¨ã—ã¦è¨˜éŒ²
  nameUsage[name] = Date.now();
  localStorage.setItem('nameUsageOrder', JSON.stringify(nameUsage));
}

// æ—¢å­˜ã®åå‰ãƒªã‚¹ãƒˆã‚’å–å¾—ï¼ˆä½¿ç”¨é †ï¼‰
function getExistingNames() {
  const data = JSON.parse(localStorage.getItem('timeCards') || '{}');
  const nameUsage = JSON.parse(localStorage.getItem('nameUsageOrder') || '{}');
  const names = Object.keys(data);
  
  // å„åå‰ã®ä½¿ç”¨é †åºã‚’å–å¾—ã—ã¦ã‚½ãƒ¼ãƒˆ
  const namesWithUsage = names.map(name => {
    const lastUsed = nameUsage[name] || 0; // ä½¿ç”¨é †åºï¼ˆæ•°å­—ãŒå¤§ãã„ã»ã©æœ€è¿‘ä½¿ç”¨ï¼‰
    return { name, lastUsed };
  });
  
  // ä½¿ç”¨é †åºã®é™é †ã§ã‚½ãƒ¼ãƒˆï¼ˆæœ€è¿‘ä½¿ã£ãŸé †ï¼‰
  namesWithUsage.sort((a, b) => {
    return b.lastUsed - a.lastUsed;
  });
  
  return namesWithUsage.map(item => item.name);
}

// ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
function updateClearButton(inputId, clearBtnId) {
  const input = document.getElementById(inputId);
  const clearBtn = document.getElementById(clearBtnId);
  
  if (input && clearBtn) {
    if (input.value.trim()) {
      clearBtn.classList.add('show');
    } else {
      clearBtn.classList.remove('show');
    }
  }
}

// ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
function showDropdown(inputId, dropdownId) {
  if (isDropdownActionInProgress) return;
  
  // ä»–ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’å…ˆã«é–‰ã˜ã‚‹
  if (dropdownId === 'nameDropdown') {
    hideDropdown('searchDropdown');
  } else if (dropdownId === 'searchDropdown') {
    hideDropdown('nameDropdown');
  }
  
  const input = document.getElementById(inputId);
  const dropdown = document.getElementById(dropdownId);
  const names = getExistingNames();
  const inputValue = input.value.toLowerCase().trim();
  
  // å…¥åŠ›å€¤ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  const filteredNames = names.filter(name => 
    name.toLowerCase().includes(inputValue)
  );
  
  dropdown.innerHTML = '';
  
  if (filteredNames.length === 0) {
    const emptyDiv = document.createElement('div');
    emptyDiv.className = 'dropdown-empty';
    emptyDiv.textContent = inputValue ? 'è©²å½“ã™ã‚‹åå‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' : 'è¨˜éŒ²ã•ã‚ŒãŸåå‰ã¯ã‚ã‚Šã¾ã›ã‚“';
    dropdown.appendChild(emptyDiv);
  } else {
    filteredNames.forEach(name => {
      const item = document.createElement('div');
      item.className = 'dropdown-item';
      
      const nameSpan = document.createElement('span');
      nameSpan.textContent = name;
      
      // æœ€å¾Œã®ä½¿ç”¨æ—¥ã‚’å–å¾—
      const nameUsage = JSON.parse(localStorage.getItem('nameUsageOrder') || '{}');
      const lastUsed = nameUsage[name];
      const infoSpan = document.createElement('span');
      infoSpan.className = 'dropdown-item-info';
      if (lastUsed) {
        const lastUsedDate = new Date(lastUsed);
        const today = new Date();
        const diffDays = Math.floor((today - lastUsedDate) / (1000 * 60 * 60 * 24));
        
        if (diffDays === 0) {
          infoSpan.textContent = 'ä»Šæ—¥ä½¿ç”¨';
        } else if (diffDays === 1) {
          infoSpan.textContent = 'æ˜¨æ—¥ä½¿ç”¨';
        } else if (diffDays < 7) {
          infoSpan.textContent = `${diffDays}æ—¥å‰ä½¿ç”¨`;
        } else {
          infoSpan.textContent = `${Math.floor(diffDays / 7)}é€±é–“å‰ä½¿ç”¨`;
        }
      } else {
        infoSpan.textContent = '';
      }
      
      item.appendChild(nameSpan);
      item.appendChild(infoSpan);
      
      const handleItemClick = () => {
        isDropdownActionInProgress = true;
        input.value = name;
        hideDropdown(dropdownId);
        
        // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚ˆã£ã¦å¾Œå‡¦ç†ã‚’åˆ†ã‘ã‚‹
        if (inputId === 'name') {
          // åå‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å ´åˆï¼šã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡ã‚’æ›´æ–°
          updateClearButton('name', 'clearNameBtn');
        } else if (inputId === 'searchName') {
          // æ¤œç´¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å ´åˆï¼šæ¤œç´¢çµæœã‚’æ›´æ–°
          displayTimeCards();
          updateClearButton('searchName', 'clearSearchBtn');
        }
        
        // ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
        setTimeout(() => {
          isDropdownActionInProgress = false;
        }, 300);
      };

      item.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        handleItemClick();
      });
      
      dropdown.appendChild(item);
    });
  }
  
  dropdown.classList.add('show');
}

// ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’éè¡¨ç¤º
function hideDropdown(dropdownId) {
  const dropdown = document.getElementById(dropdownId);
  dropdown.classList.remove('show');
}

// å…¨ã¦ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’éè¡¨ç¤º
function hideAllDropdowns() {
  hideDropdown('nameDropdown');
  hideDropdown('searchDropdown');
}

/***********************************************
 * ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
 ***********************************************/

// æœ‰çµ¦ãƒã‚§ãƒƒã‚¯
document.getElementById('isPaidLeave').addEventListener('change', async function() {
  if (this.checked) {
    const pwd = await showPromptDialog(
      'æœ‰çµ¦ç™»éŒ²',
      'æœ‰çµ¦ã¨ã—ã¦ç™»éŒ²ã™ã‚‹ãŸã‚ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:'
    );
    
    if (pwd === "4564") {
      document.getElementById('normalDateGroup').classList.add('hidden');
      document.getElementById('paidLeaveYearGroup').classList.remove('hidden');
      document.getElementById('multiDateGroup').classList.remove('hidden');
      document.getElementById('dateSingle').required = false;
      document.getElementById('paidLeaveYear').required = true;
      document.getElementById('dateMulti').required = true;
    } else if (pwd) {
      showToast("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™", 'error');
      this.checked = false;
    } else {
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆ
      this.checked = false;
    }
  } else {
    document.getElementById('normalDateGroup').classList.remove('hidden');
    document.getElementById('paidLeaveYearGroup').classList.add('hidden');
    document.getElementById('multiDateGroup').classList.add('hidden');
    document.getElementById('dateSingle').required = true;
    document.getElementById('paidLeaveYear').required = false;
    document.getElementById('dateMulti').required = false;
  }
});

document.getElementById('timeCardForm').addEventListener('submit', function(e) {
  e.preventDefault();
  if (editingRecord) {
    updateTimeCard();
  } else {
    saveTimeCard();
  }
});

document.getElementById('cancelEditBtn').addEventListener('click', cancelEdit);

document.getElementById('exportBtn').addEventListener('click', exportToExcel);
document.getElementById('clearDataBtn').addEventListener('click', requestPasswordAndClearData);
document.getElementById('backupBtn').addEventListener('click', backupData);
document.getElementById('backupLatestMonthBtn').addEventListener('click', backupLatestMonthData);
document.getElementById('restoreBtn').addEventListener('click', function() {
  document.getElementById('restoreFile').click();
});
document.getElementById('restoreFile').addEventListener('change', function(e) {
  restoreData(e.target.files[0]);
});

// æ¤œç´¢æ©Ÿèƒ½
document.getElementById('searchName').addEventListener('input', function() {
  displayTimeCards();
});

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿
document.addEventListener('DOMContentLoaded', function() {
  // ãƒ†ãƒ¼ãƒã®åˆæœŸåŒ–
  initTheme();
  
  // ãƒ†ãƒ¼ãƒãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
  const themeToggle = document.getElementById('themeToggle');
  if (themeToggle) {
    themeToggle.addEventListener('click', toggleTheme);
  }

  // æœ‰çµ¦ã®å¹´å…¥åŠ›ã«ç¾åœ¨å¹´ã‚’è¨­å®š
  const currentYear = new Date().getFullYear();
  const yearInput = document.getElementById('paidLeaveYear');
  if (yearInput) {
    yearInput.value = currentYear;
  }

  // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³æ©Ÿèƒ½ã®è¨­å®š
  const nameInput = document.getElementById('name');
  const searchInput = document.getElementById('searchName');
  const clearNameBtn = document.getElementById('clearNameBtn');
  const clearSearchBtn = document.getElementById('clearSearchBtn');
  
  // åå‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¤ãƒ™ãƒ³ãƒˆ
  nameInput.addEventListener('focus', () => {
    if (!isDropdownActionInProgress) {
      showDropdown('name', 'nameDropdown');
      updateClearButton('name', 'clearNameBtn');
    }
  });
  
  nameInput.addEventListener('input', () => {
    if (!isDropdownActionInProgress) {
      showDropdown('name', 'nameDropdown');
      updateClearButton('name', 'clearNameBtn');
    }
  });
  
  nameInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      hideDropdown('nameDropdown');
      e.preventDefault();
    }
  });
  
  // æ¤œç´¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¤ãƒ™ãƒ³ãƒˆ
  searchInput.addEventListener('focus', () => {
    showDropdown('searchName', 'searchDropdown');
    updateClearButton('searchName', 'clearSearchBtn');
  });
  
  searchInput.addEventListener('input', () => {
    if (!isDropdownActionInProgress) {
      displayTimeCards();
      showDropdown('searchName', 'searchDropdown');
      updateClearButton('searchName', 'clearSearchBtn');
    }
  });
  
  searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      hideDropdown('searchDropdown');
      e.preventDefault();
    }
  });
  
  // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
  clearNameBtn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    
    nameInput.value = '';
    clearNameBtn.classList.remove('show');
    hideDropdown('nameDropdown');
    nameInput.focus();
  });
  
  clearSearchBtn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    
    searchInput.value = '';
    clearSearchBtn.classList.remove('show');
    hideDropdown('searchDropdown');
    displayTimeCards();
    searchInput.focus();
  });
  
  // å¤–éƒ¨ã‚¯ãƒªãƒƒã‚¯ã§ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
  document.addEventListener('click', (e) => {
    if (isDropdownActionInProgress) return;
    
    if (!e.target.closest('.input-wrapper')) {
      hideAllDropdowns();
    }
  });
  
  // ESCã‚­ãƒ¼ã§ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      hideAllDropdowns();
    }
  });
  
  // åˆæœŸè¡¨ç¤º
  displayTimeCards();
  updateClearButton('name', 'clearNameBtn');
  updateClearButton('searchName', 'clearSearchBtn');
});

/***********************************************
 * saveTimeCard, displayTimeCards, deleteTimeCard
 ***********************************************/

function saveTimeCard() {
  const name = document.getElementById('name').value.trim();
  const isPaidLeave = document.getElementById('isPaidLeave').checked;

  if (!name) {
    showToast('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
    return;
  }
  const checkIn = document.getElementById('checkIn').value;
  const checkOut = document.getElementById('checkOut').value;
  if (!checkIn) {
    showToast('å‡ºå‹¤æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
    return;
  }

  let finalDates = [];
  if (isPaidLeave) {
    const paidLeaveYear = document.getElementById('paidLeaveYear').value.trim();
    let dateMulti = document.getElementById('dateMulti').value.trim();
    if (!paidLeaveYear) {
      showToast('æœ‰çµ¦ç”¨ã®è¥¿æš¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
      return;
    }
    if (!dateMulti) {
      showToast('æœˆæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
      return;
    }
    // "0212"â†’"02-12"
    const splitted = dateMulti.split(',')
      .map(s => s.trim())
      .filter(s => s !== '')
      .map(s => (s.length===4 && s.indexOf('-')===-1) ? s.slice(0,2)+'-'+s.slice(2) : s);
    if (splitted.length === 0) {
      showToast('æœˆæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
      return;
    }
    finalDates = splitted.map(md => `${paidLeaveYear}-${md}`);
  } else {
    const dateSingle = document.getElementById('dateSingle').value;
    if (!dateSingle) {
      showToast('æœˆæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
      return;
    }
    finalDates = [dateSingle];
  }

  const timeCardData = { 
    checkIn, 
    checkOut: checkOut || null, // é€€å‹¤æ™‚é–“ãŒç©ºã®å ´åˆã¯null
    isPaidLeave 
  };
  let allTimeCards = JSON.parse(localStorage.getItem('timeCards')) || {};
  if (!allTimeCards[name]) {
    allTimeCards[name] = {};
  }
  finalDates.forEach(dateStr => {
    if (!allTimeCards[name][dateStr]) {
      allTimeCards[name][dateStr] = [];
    }
    allTimeCards[name][dateStr].push(timeCardData);
  });
  localStorage.setItem('timeCards', JSON.stringify(allTimeCards));

  // åå‰ã®ä½¿ç”¨é †åºã‚’è¨˜éŒ²
  updateNameUsageOrder(name);

  // é€ä¿¡å¾Œã®ãƒªã‚»ãƒƒãƒˆå‡¦ç†
  if (!isPaidLeave) {
    document.getElementById('timeCardForm').reset();
    document.getElementById('isPaidLeave').checked = false;
    document.getElementById('normalDateGroup').classList.remove('hidden');
    document.getElementById('paidLeaveYearGroup').classList.add('hidden');
    document.getElementById('multiDateGroup').classList.add('hidden');
    document.getElementById('dateSingle').required = true;
    document.getElementById('paidLeaveYear').required = false;
    document.getElementById('dateMulti').required = false;
    // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚‚éè¡¨ç¤ºã«ã™ã‚‹
    updateClearButton('name', 'clearNameBtn');
    if (checkOut) {
      showToast('é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸï¼ˆé€šå¸¸å‹¤å‹™ï¼‰', 'success');
    } else {
      showToast('å‡ºå‹¤ã‚’è¨˜éŒ²ã—ã¾ã—ãŸã€‚é€€å‹¤æ™‚ã¯å†åº¦ç™»éŒ²ã—ã¦ãã ã•ã„', 'info');
    }
  } else {
    document.getElementById('checkIn').value = "";
    document.getElementById('checkOut').value = "";
    document.getElementById('dateMulti').value = "";
    showToast('é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸï¼ˆæœ‰çµ¦ï¼‰', 'success');
  }

  displayTimeCards();
}

function displayTimeCards() {
  const searchName = document.getElementById('searchName').value.trim().toLowerCase();
  const allTimeCards = JSON.parse(localStorage.getItem('timeCards')) || {};
  const resultDiv = document.getElementById('result');
  resultDiv.innerHTML = '<h2>å‹¤æ€ ä¸€è¦§</h2>';

  for (let name in allTimeCards) {
    if (searchName && !name.toLowerCase().includes(searchName)) continue;
    resultDiv.innerHTML += `<h3>${name}</h3>`;
    const sortedDates = Object.keys(allTimeCards[name]).sort();
    sortedDates.forEach(date => {
      if (Array.isArray(allTimeCards[name][date])) {
        allTimeCards[name][date].forEach((card, index) => {
          if (card && card.checkIn) { // å‡ºå‹¤æ™‚é–“ãŒã‚ã‚Œã°è¡¨ç¤º
            const paidLabel = card.isPaidLeave ? '<span class="record-status status-paid">æœ‰çµ¦</span>' : '';
            const checkOutDisplay = card.checkOut ? card.checkOut : '<span class="record-status status-incomplete">æœªç™»éŒ²</span>';
            
            // åˆ†å‰²ãƒœã‚¿ãƒ³ã¯å‡ºå‹¤ãƒ»é€€å‹¤ä¸¡æ–¹ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤º
            const splitButton = card.checkOut ? 
              `<button class="btn-info btn-xs" onclick="splitTimeCard('${name}', '${date}', ${index})">åˆ†å‰²</button>` : '';
            
            resultDiv.innerHTML += `
              <div class="record-card">
                <div class="record-info">
                  <span class="record-date">${formatDate(date)}</span>
                  <span class="record-time">${card.checkIn}</span>
                  <span>â†’</span>
                  <span class="record-time">${checkOutDisplay}</span>
                  ${paidLabel}
                </div>
                <div class="record-buttons">
                  <button class="btn-warning btn-xs" onclick="editTimeCard('${name}', '${date}', ${index})">ç·¨é›†</button>
                  ${splitButton}
                  <button class="btn-danger btn-xs" onclick="deleteTimeCard('${name}', '${date}', ${index})">å‰Šé™¤</button>
                </div>
              </div>
            `;
          }
        });
      }
    });
  }
}

function deleteTimeCard(name, date, index) {
  showConfirmDialog(
    'è¨˜éŒ²ã®å‰Šé™¤',
    'æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ',
    () => {
      let allTimeCards = JSON.parse(localStorage.getItem('timeCards')) || {};
      allTimeCards[name][date].splice(index, 1);
      if (allTimeCards[name][date].length === 0) {
        delete allTimeCards[name][date];
      }
      if (Object.keys(allTimeCards[name]).length === 0) {
        delete allTimeCards[name];
      }
      localStorage.setItem('timeCards', JSON.stringify(allTimeCards));
      displayTimeCards();
      showToast('è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
    }
  );
}

/****************************************************
 * ç·¨é›†æ©Ÿèƒ½
 ****************************************************/
function editTimeCard(name, date, index) {
  const allTimeCards = JSON.parse(localStorage.getItem('timeCards')) || {};
  const card = allTimeCards[name][date][index];
  
  if (!card) return;
  
  // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«è¨­å®š
  editingRecord = { name, date, index };
  
  // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
  document.getElementById('name').value = name;
  document.getElementById('dateSingle').value = date;
  document.getElementById('checkIn').value = card.checkIn || '';
  document.getElementById('checkOut').value = card.checkOut || '';
  document.getElementById('isPaidLeave').checked = card.isPaidLeave || false;
  
  // æœ‰çµ¦ãƒã‚§ãƒƒã‚¯ã®çŠ¶æ…‹ã«å¿œã˜ã¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’èª¿æ•´
  if (card.isPaidLeave) {
    const yearMatch = date.match(/^(\d{4})-/);
    if (yearMatch) {
      const yearInput = document.getElementById('paidLeaveYear');
      yearInput.value = yearMatch[1];
      document.getElementById('dateMulti').value = formatDate(date);
    }
    document.getElementById('normalDateGroup').classList.add('hidden');
    document.getElementById('paidLeaveYearGroup').classList.remove('hidden');
    document.getElementById('multiDateGroup').classList.remove('hidden');
    document.getElementById('dateSingle').required = false;
    document.getElementById('paidLeaveYear').required = true;
    document.getElementById('dateMulti').required = true;
  }
  
  // ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’å¤‰æ›´
  document.getElementById('submitBtn').textContent = 'æ›´æ–°';
  document.getElementById('cancelEditBtn').classList.remove('hidden');
  
  // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
  updateClearButton('name', 'clearNameBtn');
  
  // ãƒ•ã‚©ãƒ¼ãƒ ã®å…ˆé ­ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  document.getElementById('timeCardForm').scrollIntoView({ behavior: 'smooth' });
}

function updateTimeCard() {
  const name = document.getElementById('name').value.trim();
  const isPaidLeave = document.getElementById('isPaidLeave').checked;

  if (!name) {
    showToast('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
    return;
  }
  
  const checkIn = document.getElementById('checkIn').value;
  const checkOut = document.getElementById('checkOut').value;
  
  if (!checkIn) {
    showToast('å‡ºå‹¤æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
    return;
  }

  // æ›´æ–°ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
  const timeCardData = { 
    checkIn, 
    checkOut: checkOut || null, // é€€å‹¤æ™‚é–“ãŒç©ºã®å ´åˆã¯null
    isPaidLeave 
  };
  
  let allTimeCards = JSON.parse(localStorage.getItem('timeCards')) || {};
  
  // å…ƒã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤
  allTimeCards[editingRecord.name][editingRecord.date].splice(editingRecord.index, 1);
  if (allTimeCards[editingRecord.name][editingRecord.date].length === 0) {
    delete allTimeCards[editingRecord.name][editingRecord.date];
  }
  if (Object.keys(allTimeCards[editingRecord.name]).length === 0) {
    delete allTimeCards[editingRecord.name];
  }
  
  // æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦è¿½åŠ 
  let finalDates = [];
  if (isPaidLeave) {
    const paidLeaveYear = document.getElementById('paidLeaveYear').value.trim();
    let dateMulti = document.getElementById('dateMulti').value.trim();
    if (!paidLeaveYear || !dateMulti) {
      showToast('æœ‰çµ¦ç”¨ã®è¥¿æš¦ã¨æœˆæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
      return;
    }
    const splitted = dateMulti.split(',')
      .map(s => s.trim())
      .filter(s => s !== '')
      .map(s => (s.length===4 && s.indexOf('-')===-1) ? s.slice(0,2)+'-'+s.slice(2) : s);
    finalDates = splitted.map(md => `${paidLeaveYear}-${md}`);
  } else {
    const dateSingle = document.getElementById('dateSingle').value;
    if (!dateSingle) {
      showToast('æœˆæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
      return;
    }
    finalDates = [dateSingle];
  }
  
  if (!allTimeCards[name]) {
    allTimeCards[name] = {};
  }
  finalDates.forEach(dateStr => {
    if (!allTimeCards[name][dateStr]) {
      allTimeCards[name][dateStr] = [];
    }
    allTimeCards[name][dateStr].push(timeCardData);
  });
  
  localStorage.setItem('timeCards', JSON.stringify(allTimeCards));
  
  // åå‰ã®ä½¿ç”¨é †åºã‚’æ›´æ–°
  updateNameUsageOrder(name);
  
  showToast('æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
  cancelEdit();
  displayTimeCards();
}

function cancelEdit() {
  editingRecord = null;
  
  // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
  document.getElementById('timeCardForm').reset();
  document.getElementById('isPaidLeave').checked = false;
  
  // ãƒ•ã‚©ãƒ¼ãƒ ã®è¡¨ç¤ºã‚’é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã™
  document.getElementById('normalDateGroup').classList.remove('hidden');
  document.getElementById('paidLeaveYearGroup').classList.add('hidden');
  document.getElementById('multiDateGroup').classList.add('hidden');
  document.getElementById('dateSingle').required = true;
  document.getElementById('paidLeaveYear').required = false;
  document.getElementById('dateMulti').required = false;
  
  // ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æˆ»ã™
  document.getElementById('submitBtn').textContent = 'é€ä¿¡';
  document.getElementById('cancelEditBtn').classList.add('hidden');
  
  // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
  updateClearButton('name', 'clearNameBtn');
}

/****************************************************
 * åˆ†å‰²æ©Ÿèƒ½ï¼ˆä¸­æŠœã‘å¯¾å¿œï¼‰
 ****************************************************/
function splitTimeCard(name, date, index) {
  const allTimeCards = JSON.parse(localStorage.getItem('timeCards')) || {};
  const card = allTimeCards[name][date][index];
  
  if (!card || !card.checkIn || !card.checkOut) {
    showToast('å‡ºå‹¤ãƒ»é€€å‹¤æ™‚é–“ãŒä¸¡æ–¹ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹è¨˜éŒ²ã®ã¿åˆ†å‰²ã§ãã¾ã™', 'warning');
    return;
  }
  
  // åˆ†å‰²æ™‚é–“å…¥åŠ›ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
  showPromptDialog(
    'ä¸­æŠœã‘é–‹å§‹æ™‚é–“',
    `ä¸­æŠœã‘é–‹å§‹æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\n\nã€å…¥åŠ›ä¾‹ã€‘\nãƒ»12:00 ã¾ãŸã¯ 1200\nãƒ»08:20 ã¾ãŸã¯ 0820\n\nç¾åœ¨ã®è¨˜éŒ²:\nå‡ºå‹¤: ${card.checkIn}\né€€å‹¤: ${card.checkOut}`
  ).then((breakStartInput) => {
    if (!breakStartInput) return;
    
    const breakStart = normalizeTimeInput(breakStartInput);
    if (!breakStart) {
      showToast('ç„¡åŠ¹ãªæ™‚åˆ»å½¢å¼ã§ã™ã€‚\n\næœ‰åŠ¹ãªå½¢å¼:\nãƒ»HH:MMï¼ˆä¾‹ï¼š12:00ï¼‰\nãƒ»HHMMï¼ˆä¾‹ï¼š1200ï¼‰\nãƒ»HMMï¼ˆä¾‹ï¼š820ï¼‰', 'error');
      return;
    }
    
    showPromptDialog(
      'ä¸­æŠœã‘çµ‚äº†æ™‚é–“',
      `ä¸­æŠœã‘çµ‚äº†æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\n\nã€å…¥åŠ›ä¾‹ã€‘\nãƒ»13:00 ã¾ãŸã¯ 1300\nãƒ»08:20 ã¾ãŸã¯ 0820\n\nç¾åœ¨ã®è¨˜éŒ²:\nå‡ºå‹¤: ${card.checkIn}\né€€å‹¤: ${card.checkOut}\nä¸­æŠœã‘é–‹å§‹: ${breakStart}`
    ).then((breakEndInput) => {
      if (!breakEndInput) return;
      
      const breakEnd = normalizeTimeInput(breakEndInput);
      if (!breakEnd) {
        showToast('ç„¡åŠ¹ãªæ™‚åˆ»å½¢å¼ã§ã™ã€‚\n\næœ‰åŠ¹ãªå½¢å¼:\nãƒ»HH:MMï¼ˆä¾‹ï¼š13:00ï¼‰\nãƒ»HHMMï¼ˆä¾‹ï¼š1300ï¼‰\nãƒ»HMMï¼ˆä¾‹ï¼š830ï¼‰', 'error');
        return;
      }
      
      // æ™‚é–“ã®å¦¥å½“æ€§ã‚’ãƒã‚§ãƒƒã‚¯
      if (!isValidTimeOrder(card.checkIn, breakStart, breakEnd, card.checkOut)) {
        showToast('æ™‚é–“ã®é †åºãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚\nå‡ºå‹¤æ™‚é–“ < ä¸­æŠœã‘é–‹å§‹ < ä¸­æŠœã‘çµ‚äº† < é€€å‹¤æ™‚é–“\nã«ãªã‚‹ã‚ˆã†ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\n\nå…¥åŠ›ã•ã‚ŒãŸæ™‚åˆ»:\nå‡ºå‹¤: ' + card.checkIn + '\nä¸­æŠœã‘é–‹å§‹: ' + breakStart + '\nä¸­æŠœã‘çµ‚äº†: ' + breakEnd + '\né€€å‹¤: ' + card.checkOut, 'error');
        return;
      }
      
      showConfirmDialog(
        'è¨˜éŒ²ã‚’åˆ†å‰²',
        `ä»¥ä¸‹ã®ã‚ˆã†ã«åˆ†å‰²ã—ã¾ã™ã‹ï¼Ÿ\n\nã€1ã¤ç›®ã®è¨˜éŒ²ã€‘\nå‡ºå‹¤: ${card.checkIn}\né€€å‹¤: ${breakStart}\n\nã€2ã¤ç›®ã®è¨˜éŒ²ã€‘\nå‡ºå‹¤: ${breakEnd}\né€€å‹¤: ${card.checkOut}`,
        () => {
          // å…ƒã®è¨˜éŒ²ã‚’å‰Šé™¤
          allTimeCards[name][date].splice(index, 1);
          
          // 2ã¤ã®æ–°ã—ã„è¨˜éŒ²ã‚’è¿½åŠ 
          const record1 = {
            checkIn: card.checkIn,
            checkOut: breakStart,
            isPaidLeave: card.isPaidLeave || false
          };
          
          const record2 = {
            checkIn: breakEnd,
            checkOut: card.checkOut,
            isPaidLeave: card.isPaidLeave || false
          };
          
          allTimeCards[name][date].push(record1);
          allTimeCards[name][date].push(record2);
          
          localStorage.setItem('timeCards', JSON.stringify(allTimeCards));
          
          showToast('è¨˜éŒ²ã‚’åˆ†å‰²ã—ã¾ã—ãŸ', 'success');
          displayTimeCards();
        },
        'åˆ†å‰²ã™ã‚‹'
      );
    });
  });
}

// æ™‚é–“ã®é †åºãƒã‚§ãƒƒã‚¯ç”¨é–¢æ•°
function isValidTimeOrder(time1, time2, time3, time4) {
  const t1 = new Date(`1970-01-01T${time1}`);
  const t2 = new Date(`1970-01-01T${time2}`);
  const t3 = new Date(`1970-01-01T${time3}`);
  const t4 = new Date(`1970-01-01T${time4}`);
  
  return t1 < t2 && t2 < t3 && t3 < t4;
}

// æ™‚åˆ»å…¥åŠ›ã‚’æ­£è¦åŒ–ã™ã‚‹é–¢æ•°ï¼ˆ4æ¡æ•°å­— â†’ HH:MMå½¢å¼ï¼‰
function normalizeTimeInput(input) {
  if (!input) return null;
  
  // ç©ºç™½ã‚’é™¤å»
  input = input.trim();
  
  // æ—¢ã« HH:MM å½¢å¼ã®å ´åˆã¯ãã®ã¾ã¾è¿”ã™
  if (/^\d{1,2}:\d{2}$/.test(input)) {
    const [hours, minutes] = input.split(':');
    const h = parseInt(hours, 10);
    const m = parseInt(minutes, 10);
    
    if (h >= 0 && h <= 23 && m >= 0 && m <= 59) {
      return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
    }
    return null;
  }
  
  // 4æ¡æ•°å­—ã®å ´åˆï¼ˆä¾‹ï¼š0820 â†’ 08:20ï¼‰
  if (/^\d{4}$/.test(input)) {
    const hours = parseInt(input.substring(0, 2), 10);
    const minutes = parseInt(input.substring(2, 4), 10);
    
    if (hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59) {
      return String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
    }
    return null;
  }
  
  // 3æ¡æ•°å­—ã®å ´åˆï¼ˆä¾‹ï¼š820 â†’ 08:20ï¼‰
  if (/^\d{3}$/.test(input)) {
    const hours = parseInt(input.substring(0, 1), 10);
    const minutes = parseInt(input.substring(1, 3), 10);
    
    if (hours >= 0 && hours <= 9 && minutes >= 0 && minutes <= 59) {
      return String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
    }
    return null;
  }
  
  return null;
}

/****************************************************
 * å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ (ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰)
 ****************************************************/
function requestPasswordAndClearData() {
  showPromptDialog(
    'ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢',
    'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:'
  ).then((password) => {
    if (password === '4564') {
      showConfirmDialog(
        'ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ç¢ºèª',
        'æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ',
        () => {
          localStorage.removeItem('timeCards');
          displayTimeCards();
          showToast('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
        }
      );
    } else if (password) {
      showToast('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™', 'error');
    }
  });
}

/****************************************************
 * Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (æ¯æœˆ11æ—¥ï½ç¿Œæœˆ10æ—¥ã§ã‚·ãƒ¼ãƒˆåˆ†å‰²)
 ****************************************************/
function exportToExcel() {
  const allTimeCards = JSON.parse(localStorage.getItem('timeCards')) || {};
  const workbook = XLSX.utils.book_new();

  for (let name in allTimeCards) {
    // æœŸé–“ã”ã¨ã«åˆ†é¡
    const periods = {};
    for (let date in allTimeCards[name]) {
      const period = getMonthPeriod(date); // {start, end}
      // ã‚­ãƒ¼: startï½end ã®ISO
      const periodKey = period.start.toISOString().slice(0,10) + "_" + period.end.toISOString().slice(0,10);

      if (!periods[periodKey]) {
        periods[periodKey] = [];
      }
      allTimeCards[name][date].forEach(card => {
        if (card && card.checkIn) { // å‡ºå‹¤æ™‚é–“ãŒã‚ã‚Œã°å‡¦ç†
          const checkOutTime = card.checkOut || 'æœªç™»éŒ²';
          let totalHours = 0;
          let earlyMorning = 0;
          let evening = 0;
          
          // é€€å‹¤æ™‚é–“ãŒã‚ã‚‹å ´åˆã®ã¿æ™‚é–“è¨ˆç®—
          if (card.checkOut) {
            totalHours = parseFloat(calculateTimeDifference(card.checkIn, card.checkOut));
            earlyMorning = parseFloat(calculateEarlyMorningTime(card.checkIn, card.checkOut));
            evening = parseFloat(calculateEveningTime(card.checkIn, card.checkOut));
          }
          
          periods[periodKey].push({
            date,
            checkIn: card.checkIn,
            checkOut: checkOutTime,
            totalHours,
            earlyMorning,
            evening,
            isPaidLeave: card.isPaidLeave
          });
        }
      });
    }

    // æœŸé–“ã”ã¨ã«ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ
    for (let periodKey in periods) {
      const [startStr, endStr] = periodKey.split("_");
      const startDate = new Date(startStr);
      // ã‚·ãƒ¼ãƒˆå: "åå‰ + æœˆ"
      const monthNames = ["1æœˆ","2æœˆ","3æœˆ","4æœˆ","5æœˆ","6æœˆ","7æœˆ","8æœˆ","9æœˆ","10æœˆ","11æœˆ","12æœˆ"];
      const sheetName = name + monthNames[startDate.getMonth()];

      const sheetData = [];
      sheetData.push([`åå‰: ${name}`]);
      sheetData.push(["æ—¥ä»˜","å‡ºå‹¤æ™‚é–“","é€€å‹¤æ™‚é–“","åˆè¨ˆæ™‚é–“","æœå¤•å‹¤å‹™","é€šå¸¸åˆè¨ˆ","å‹¤å‹™ç¨®åˆ¥"]);

      let overallTotalDay = 0;
      let overallMorningEvening = 0;
      let overallNormal = 0;

      // æ—¥ä»˜é †ã‚½ãƒ¼ãƒˆ
      periods[periodKey].sort((a,b) => new Date(a.date) - new Date(b.date));

      periods[periodKey].forEach(rec => {
        const morningEvening = rec.earlyMorning + rec.evening;
        const normalHours = rec.totalHours - morningEvening;
        
        // é€€å‹¤æ™‚é–“ãŒã‚ã‚‹å ´åˆã®ã¿åˆè¨ˆã«åŠ ç®—
        if (rec.checkOut !== 'æœªç™»éŒ²') {
          overallTotalDay += rec.totalHours;
          overallMorningEvening += morningEvening;
          overallNormal += normalHours;
        }

        sheetData.push([
          formatDate(rec.date),
          rec.checkIn,
          rec.checkOut,
          rec.checkOut === 'æœªç™»éŒ²' ? 'ï¼' : rec.totalHours.toFixed(2),
          rec.checkOut === 'æœªç™»éŒ²' ? 'ï¼' : morningEvening.toFixed(2),
          rec.checkOut === 'æœªç™»éŒ²' ? 'ï¼' : normalHours.toFixed(2),
          rec.isPaidLeave ? "æœ‰çµ¦" : ""
        ]);
      });

      sheetData.push([]);
      sheetData.push([
        "åˆè¨ˆ","","",
        overallTotalDay.toFixed(2),
        overallMorningEvening.toFixed(2),
        overallNormal.toFixed(2),
        ""
      ]);

      const worksheet = XLSX.utils.aoa_to_sheet(sheetData);
      XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
    }
  }

  XLSX.writeFile(workbook, "timecards.xlsx");
  showToast('Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡ºåŠ›ã—ã¾ã—ãŸ', 'success');
}

/****************************************************
 * ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— (æœ€æ–°ã®æœˆ) â†’ ä¾‹ãˆã°3/11ï½4/10ã ã‘
 ****************************************************/
function backupLatestMonthData() {
  const allTimeCards = JSON.parse(localStorage.getItem('timeCards')) || {};
  const { start, end } = getLatestMonthPeriod(); // ä»Šæ—¥åŸºæº–ã§ 11æ—¥ï½ç¿Œ10æ—¥
  const latestMonthData = {};

  for (let name in allTimeCards) {
    for (let date in allTimeCards[name]) {
      const d = new Date(date);
      if (d >= start && d <= end) {
        if (!latestMonthData[name]) {
          latestMonthData[name] = {};
        }
        latestMonthData[name][date] = allTimeCards[name][date];
      }
    }
  }

  if (Object.keys(latestMonthData).length === 0) {
    showToast('æœ€æ–°ã®æœˆã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
    return;
  }

  const dataStr = JSON.stringify(latestMonthData);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(dataBlob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'latest_month_timecards_backup.json';
  a.click();
  URL.revokeObjectURL(url);
  showToast('æœ€æ–°ã®æœˆã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ', 'success');
}

/****************************************************
 * é€šå¸¸ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒªã‚¹ãƒˆã‚¢
 ****************************************************/
function backupData() {
  const allTimeCards = JSON.parse(localStorage.getItem('timeCards')) || {};
  const dataStr = JSON.stringify(allTimeCards);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(dataBlob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'timecards_backup.json';
  a.click();
  URL.revokeObjectURL(url);
  showToast('ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¾ã—ãŸ', 'success');
}

function restoreData(file) {
  const reader = new FileReader();
  reader.onload = function(event) {
    try {
      const allTimeCards = JSON.parse(event.target.result);
      if (allTimeCards && typeof allTimeCards === 'object') {
        localStorage.setItem('timeCards', JSON.stringify(allTimeCards));
        displayTimeCards();
        showToast('ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ', 'success');
      } else {
        showToast('ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™', 'error');
      }
    } catch (e) {
      showToast('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    }
  };
  reader.readAsText(file);
}
  </script>
</body>
</html>
